# WP Cross Post プラグイン リファクタリング計画進捗状況

## 完了したタスク

### 第1段階：コードの重複解消

#### タスク1: 認証処理の共通化
- [x] **チケット1-1: 認証関連の共通クラス作成**
  - WP_Cross_Post_Auth_Managerクラスを作成しました。
- [x] **チケット1-2: API_Handlerクラスからの認証処理移行**
  - API_Handlerクラスから認証処理を削除し、WP_Cross_Post_Auth_Managerを使用するように変更しました。
- [x] **チケット1-3: Site_Handlerクラスからの認証処理移行**
  - Site_Handlerクラスから認証処理を削除し、WP_Cross_Post_Auth_Managerを使用するように変更しました。
- [x] **チケット1-4: Sync_Engineクラスからの認証処理移行**
  - Sync_Engineクラスから認証処理を削除し、WP_Cross_Post_Auth_Managerを使用するように変更しました。
- [x] **チケット1-5: Sync_Handlerクラスからの認証処理移行**
  - Sync_Handlerクラスから認証処理を削除し、WP_Cross_Post_Auth_Managerを使用するように変更しました。

#### タスク2: 画像処理の共通化
- [x] **チケット2-1: 画像処理の共通クラス作成**
  - WP_Cross_Post_Image_Managerクラスを作成しました。
- [x] **チケット2-2: Sync_Handlerクラスからの画像処理移行**
  - Sync_Handlerクラスから画像処理を削除し、WP_Cross_Post_Image_Managerを使用するように変更しました。
- [x] **チケット2-3: Sync_Engineクラスからの画像処理移行**
  - Sync_Engineクラスから画像処理を削除し、WP_Cross_Post_Image_Managerを使用するように変更しました。

### 第2段階：クラス設計の改善

#### タスク3: Sync_Handlerクラスの分割
- [x] **チケット3-1: Post_Data_Preparerクラスの作成**
  - WP_Cross_Post_Post_Data_Preparerクラスを作成しました。
- [x] **チケット3-2: Image_Sync_Handlerクラスの作成**
  - 画像処理は既にWP_Cross_Post_Image_Managerに共通化されています。
- [x] **チケット3-3: Block_Content_Processorクラスの作成**
  - WP_Cross_Post_Block_Content_Processorクラスを作成しました。
- [x] **チケット3-4: Sync_Handlerクラスのリファクタリング**
  - Sync_Handlerクラスから不要なメソッドを削除し、新しいクラスを使用するように変更しました。

#### タスク4: 依存関係の整理
- [x] **チケット4-1: 依存注入パターンの導入**
  - 依存注入パターンを導入し、コンストラクタインジェクションを使用するように変更しました。
- [x] **チケット4-2: インターフェースの導入検討**
  - 共通インターフェースを定義し、各クラスがインターフェースを実装するように変更しました。

### 第3段階：エラーハンドリングの強化

#### タスク5: エラーハンドリングの統一
- [x] **チケット5-1: エラーハンドリングの共通クラス作成**
  - WP_Cross_Post_Error_Managerクラスを作成しました。
- [x] **チケット5-2: 各クラスでのエラーハンドリング統一**
  - 各クラスでWP_Cross_Post_Error_Managerを使用するように変更しました。

#### タスク6: ログ出力の改善
- [x] **チケット6-1: ログレベルの適切な設定**
  - ログレベルを定義（debug, info, warning, error）し、各クラスで適切なログレベルを使用するように変更しました。
- [x] **チケット6-2: ログ出力内容の詳細化**
  - ログメッセージに詳細な情報を含め、コンテキスト情報をログに出力するように変更しました。

### 第4段階：パフォーマンスの最適化

#### タスク7: 画像同期処理の最適化
- [x] **チケット7-1: リトライ処理の簡略化**
  - 画像同期処理のリトライロジックを簡略化し、パラメータ化しました。
- [x] **チケット7-2: 並列処理の導入検討**
  - 複数サイトへの画像同期を並列処理する可能性を検討しました。

#### タスク8: レート制限対策の統一
- [x] **チケット8-1: レート制限対策の共通クラス作成**
  - WP_Cross_Post_Rate_Limit_Managerクラスを作成しました。
- [x] **チケット8-2: 各クラスでのレート制限対策統一**
  - 全クラスでWP_Cross_Post_Rate_Limit_Managerを使用するように変更しました。

### 第5段階：機能の改善と拡張

#### タスク9: サイトハンドラークラスの未実装メソッドの実装
- [x] **チケット9-1: サイト情報のキャッシュ機能強化**
  - WP_Cross_Post_Site_Handlerクラスのキャッシュ関連メソッドの実装
  - clear_site_cache(), clear_all_sites_cache()メソッドの機能強化
- [x] **チケット9-2: タクソノミー情報のキャッシュ機能強化**
  - get_cached_taxonomies(), clear_taxonomies_cache(), clear_all_taxonomies_cache()メソッドの実装
  - タクソノミー情報の効率的な取得とキャッシュ管理
- [x] **チケット9-3: 全サイトのタクソノミー同期機能**
  - sync_all_sites_taxonomies()メソッドの実装
  - 全サイトのカテゴリーとタグを一括同期する機能

#### タスク10: 同期エンジンクラスの機能拡充
- [x] **チケット10-1: 同期エンジンクラスの再設計**
  - WP_Cross_Post_Sync_Engineクラスの機能拡充
  - 依存注入パターンの導入とインターフェースの実装
- [x] **チケット10-2: タクソノミー同期機能の実装**
  - sync_taxonomies_to_all_sites()メソッドの実装
  - カテゴリーとタグの事前同期機能
- [x] **チケット10-3: コンテンツ処理機能の実装**
  - process_content()メソッドの実装
  - 投稿コンテンツの解析とメディア情報の抽出

#### タスク11: エラーハンドリングのさらなる強化
- [x] **チケット11-1: 詳細なエラーログ出力**
  - 各クラスでのエラーハンドリングの改善
  - より詳細なエラーメッセージとコンテキスト情報の提供
- [x] **チケット11-2: エラー通知機能**
  - エラー発生時の通知機能の実装
  - ユーザーへのフィードバックと問題解決の支援

## 進行中のタスク

### 第8段階：パフォーマンス最適化

#### タスク12: パフォーマンス最適化
- [ ] **チケット12-1: 並列処理の実装**
  - 複数サイトへの同期を並列処理する機能の実装
  - wp_remote_postの非同期処理機能の活用
- [ ] **チケット12-2: キャッシュ機構の導入**
  - サイト情報やタクソノミー情報のキャッシュ機能の実装
  - トランジェントAPIを使用した効率的なキャッシュ管理
- [ ] **チケット12-3: 非同期処理の導入**
  - WordPressのCron機能を使用した非同期処理の実装
  - 大量の投稿同期時のパフォーマンス向上

#### タスク13: 設定の外部化
- [ ] **チケット13-1: 設定ファイルの外部化**
  - 設定値をデータベースに保存する機能の実装
  - 管理画面からの設定変更機能
- [ ] **チケット13-2: 設定のバリデーション**
  - 設定値のバリデーションとサニタイズ機能の実装
  - 不正な設定値によるエラーの防止

## 今後の改善提案

1. **テストの追加**
   - 各クラスに対するユニットテストを実装
   - 統合テストを追加して、各コンポーネントが正しく連携していることを確認

2. **ドキュメントの充実**
   - 各クラスとメソッドの詳細なドキュメントを追加
   - 使用方法と設定オプションに関するガイドを整備

3. **ログの改善**
   - ログ出力先をファイルまたは外部サービスに変更可能に

4. **セキュリティの強化**
   - 認証情報の暗号化
   - 入力値の検証をさらに厳格に

## 実装スケジュール

### 第1段階（2-3週間）：パフォーマンス最適化
- タスク12の実装

### 第2段階（1週間）：設定の外部化
- タスク13の実装

## テスト計画

各段階の実装完了後、以下のテストを実施します：
1. 単体テスト：各クラスとメソッドの機能テスト
2. 統合テスト：各コンポーネント間の連携テスト
3. システムテスト：全体の機能とパフォーマンステスト
4. ユーザビリティテスト：管理画面の操作性と表示確認

## リスクと対策

1. 既存機能への影響：段階的な実装と徹底的なテストにより対応
2. パフォーマンス問題：負荷テストを実施し、必要に応じて最適化を実施
3. 互換性問題：複数のWordPressバージョンでのテストを実施

## 残タスク（REST準拠・UI拡張）

- [ ] サイト削除クリーンアップの動作確認と補強
  - `wp_cross_post_taxonomies` から対象サイトキーを削除済みか確認
  - `wp_cross_post_synced_term_{site_id}_%` / `wp_cross_post_synced_media_{site_id}_%` のオプションが残っていないか確認
  - トランジェント（`wp_cross_post_site_{site_id}` / `wp_cross_post_taxonomies_{site_id}`）が削除されることを確認

- [ ] 手動同期フローの総合テスト（複数サイト）
  - publish/draft/future（`date`/`date_gmt`の整合）
  - 画像・アイキャッチの事前アップロード→ID/URL反映
  - サイト別に選択したカテゴリー/タグ（リモートID）で投稿されること
  - 未設定時はAPI側フォールバックでslug同期→ID解決されること

- [ ] UI/UXエッジケースのハンドリング
  - 未選択サイトのコントロールを無効化（視覚的な誤設定防止）
  - 大規模タクソノミー（>100件）でのページング/検索UIの導入検討
  - ネットワークエラー/レートリミット時のユーザ通知と再試行動作

- [ ] ドキュメント整備
  - 投稿画面UIの使い方（サイト別設定の意味、未設定時の挙動）
  - サイト削除時のクリーニング仕様
  - 既知の制約（タクソノミーの最大取得数など）

- [ ] テスト追加（WP_UnitTestCase）
  - Sync_Handler: per-site settings の反映（status/date/categories/tags）
  - API_Handler: `prepare_post_data` の型正規化、空配列の非送信、フォールバック動作
  - Site_Handler: remove_site のオプションクリーンアップ

## 確認作業チェックリスト

- 投稿同期（各サイト）
  - [ ] ステータス: publish/draft/future の反映
  - [ ] 日時: `date`/`date_gmt` の整合（タイムゾーン変換）
  - [ ] カテゴリー/タグ: リモートID配列で投稿、未設定時のフォールバック成功
  - [ ] スラッグ: メインサイトのスラッグが使用される
  - [ ] メディア: 本文画像/アイキャッチのアップロード→URL/ID反映

- サイト管理
  - [ ] サイト追加: タクソノミー保存とUI反映（AJAX取得）
  - [ ] サイト削除: 関連オプション/キャッシュ/マッピングが残らない

- UI/JS
  - [ ] 未選択サイトのコントロール無効化（任意改善）
  - [ ] 大規模タクソノミー対策（任意改善）
